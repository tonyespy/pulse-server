#!/bin/bash -ex

[ -e "$PULSE_STATE_PATH" ] || mkdir -p "$PULSE_STATE_PATH"

EXTRA_ARGS=()

if [ -e "$SNAP_DATA"/config/debug ] ; then
    EXTRA_ARGS+=(-vvvv)
    export LIBASOUND_DEBUG=1
fi

LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$SNAP/usr/lib/pulseaudio:$SNAP/usr/lib/pulseaudio/modules"
PA_MODULES="$SNAP/usr/lib/pulseaudio/modules"

sleep 1

exec "$SNAP"/usr/bin/pulseaudio \
    --exit-idle-time=-1 \
    --disallow-exit=yes \
    --system \
    -p $PA_MODULES \
    -F $SNAP/etc/pulse/system.pa \
    -n \
    "${EXTRA_ARGS[@]}"
